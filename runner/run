#!/bin/bash

# Usage message function
show_usage() {
    echo "Usage: $0 <number> [-s <value>] [additional options]"
    echo "Arguments:"
    echo "  <number>            Number of Bits to crack"
    echo "  -s <value>          Optional share value (must be <= 10000)"
    echo "  additional options  Additional arguments passed to the command"
    exit 1
}

# Function to validate and set the share value
set_share_value() {
    local share="$1"
    if [[ "$share" =~ ^[0-9]+$ ]]; then
        if [ "$share" -le 10 ]; then
            SHARE_VALUE="${share}/10"
        elif [ "$share" -le 100 ]; then
            SHARE_VALUE="${share}/100"
        elif [ "$share" -le 1000 ]; then
            SHARE_VALUE="${share}/1000"
        elif [ "$share" -le 10000 ]; then
            SHARE_VALUE="${share}/10000"
        else
            echo "Error: Share value must be <= 10000."
            exit 1
        fi
    else
        echo "Error: --share requires a numeric value."
        exit 1
    fi
}

# Function to parse and process arguments
parse_arguments() {
    if [ $# -lt 1 ]; then
        show_usage
    fi
    
    BITS=$1
    shift
    
    while (( "$#" )); do
        case "$1" in
            -s)
                if [ -n "$2" ]; then
                    set_share_value "$2"
                    shift 2
                else
                    echo "Error: -s requires a value."
                    exit 1
                fi
                ;;
            *)
                ADDITIONAL_ARGS="$ADDITIONAL_ARGS $1"
                shift
                ;;
        esac
    done
}

# Function to extract parameters from params.txt based on the given number
extract_params() {
    local params=$(grep "^$BITS " $PARAMS_FILE)
    
    if [ -z "$params" ]; then
        echo "No parameters found for number $BITS"
        exit 1
    fi
    
    ADDRESS=$(echo "$params" | awk '{print $2}')
    KEYSPACE=$(echo "$params" | awk '{print $3}')
}

# Function to initialize directories and paths
initialize_paths() {
    SHARE=$(echo "$SHARE_VALUE" | awk -F'/' '{print $1}')

    if [[ -z "${DATA_DIR}" ]]; then
      echo "ERROR: DATA_DIR environment variable is not set."
      exit 1
    fi

    if [[ -z "${BIN_PATH}" ]]; then
      echo "ERROR: BIN_PATH environment variable is not set."
      exit 1
    fi

    echo "Using data directory: ${DATA_DIR}"

    OUT_FILE="${DATA_DIR}/out${BITS}.txt"
    CP_FILE="${DATA_DIR}/cp-${BITS}-${SHARE}.txt"
    PARAMS_FILE="${DATA_DIR}/params.txt"
}

# Function to build the command with the provided parameters
build_command() {
    COMMAND="$BIN_PATH $ADDRESS -c -o $OUT_FILE -b $D_BLOCKS -t $D_THREADS -p $D_POINTS --keyspace $KEYSPACE --continue $CP_FILE"
    
    # Append share if provided
    if [ -n "$SHARE_VALUE" ]; then
        COMMAND="$COMMAND --share $SHARE_VALUE"
    fi
    
    # Append additional arguments
    COMMAND="$COMMAND $ADDITIONAL_ARGS"
}

# Function to execute the constructed command
execute_command() {
    echo "Running command: $COMMAND"
    eval "$COMMAND"
}

# Main script execution
main() {
    # Initialized in Dockerfile
    # DATA_DIR=$DATA_DIR
    # BIN_PATH=$BIN_PATH
    
    # Initialize constants
    D_BLOCKS=512
    D_THREADS=256
    D_POINTS=1024
    
    # Parse and validate arguments
    parse_arguments "$@"

    # Initialize output and checkpoint file paths
    initialize_paths
    
    # Extract address and keyspace for the given number
    extract_params
    
    # Construct and execute the command
    build_command
    execute_command
}

# Run main with all arguments
main "$@"
